---
title: "Analysis of Equities in BIST30 Index (XU030 Index)"
author: "Data Jugglers"
date: "November 21, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: sandstone
    highlight: kate
    df_print: paged
    fig_width: 11
    fig_height: 7
    fig_crop: false
classoption: landscape
geometry: margin=0in
---

# 1) Needed Libraries


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      results = "hide")
library(Hmisc)
library(gridExtra)
library(GGally)
library(tibble)
library(dplyr)
library(tidyr)
library(reshape2)
library(tidyverse)
library(ggplot2)
library(corrgram)
library(corrplot)
library(date)
library(readxl)
library(knitr)
```


```{r analysis, results="markup"}
library(Hmisc)
library(gridExtra)
library(GGally)
library(tibble)
library(dplyr)
library(tidyr)
library(reshape2)
library(tidyverse)
library(ggplot2)
library(corrgram)
library(corrplot)
library(date)
library(readxl)
library(knitr)


```

# 2) Data Preparations



In this project, we are analyzing the BIST30 members as of November 2018. The data set consist of last price ad volume data of equities listed in BIST30 Index from January 2011 to November 2018.
Firstly, 
*we have examined the data structure and, 
*made some little transformation in the columns of data frame.


```{r}
tmp<-tempfile(fileext=".xlsx")
download.file("https://github.com/MEF-BDA503/gpj18-data-jugglers/blob/master/XU030_v2.xlsx?raw=true",destfile=tmp,mode='wb')

bist30=read_xlsx(tmp)

```

```{r}
str(bist30)
```

```{r include=FALSE}
as.Date(bist30$Dates,format="%y-%m-%d")
str(bist30$Dates)
range(bist30$Dates)
head(bist30)
tail(bist30)
```

# 3) Beta Analysis
**Normalization**:
Before starting beta analysis, we should normalize the data as we take date 01.01.2011 equals to 100 for all stocks' price.

```{r}
tmp<-tempfile(fileext=".xlsx")
download.file("https://github.com/MEF-BDA503/gpj18-data-jugglers/blob/master/XU030_v2.xlsx?raw=true",destfile=tmp,mode='wb')
bist30=read_xlsx(tmp)

bist30 <- cbind(bist30, apply(bist30[seq(2,60,2)], 2, function (a) a / a[[1]] * 100))

colnames(bist30)[62:91] <- paste(colnames(bist30[seq(2,60,2)]), "norm", sep = "_")

head(bist30[62:90],10)

```


We will divide the data into two groups, financial sector companies, reel sector companies. Then we will compare two groups according to the annual yields, and illustrate them by graphics for each year. 

# 4) Correlation and Regression Analysis of Volume and Price {.tabset .tabset-fade .tabset-pills}

## 1) Correlation Tables for Normalized and Raw Data


**Corrgram** is a good source for correlation table, we can see the desired relations between two values in table by looking the

```{r}
bistCorr30 <- bist30[2:60]
corrValuesTable <- cor(bist30[2:60],bist30[2:60])
corrgram(corrValuesTable,order=TRUE, lower.panel=panel.shade,
  upper.panel=panel.pie, text.panel=panel.txt,
  main="Correlation Data in Volume-Price Order")
```

Another correlation table for variables is provided by **corrplot** package. This is the visualization of it 

```{r}
corrplot(corrValuesTable, type = "upper", tl.pos = "td",
         method = "circle", tl.cex = 0.5, tl.col = 'black',
         order = "hclust", diag = FALSE)
```

Another correlation relation could be seen between normalized prices as below.

```{r}
corrValuesPrices <- cor(bist30[62:90],bist30[62:90])
corrgram(corrValuesPrices,order=TRUE, lower.panel=panel.shade,
  upper.panel=panel.pie, text.panel=panel.txt,
  main="Correlation Data in Price Order")
```

And corrplot version of it

```{r}
corrplot(corrValuesPrices, type = "upper", tl.pos = "td",
         method = "circle", tl.cex = 0.5, tl.col = 'black',
         order = "hclust", diag = FALSE)
```

## 2) The Correlation Values between Volume and Price

We should investigate that is there any meaningful connection between volume values and price values. If there is, we can assuma some predictions about company stock's volumes or prices from another.

First we need company names vector for table

```{r}
companyNames <- c('GARAN','SAHOL','BIMAS','ARCLK','EREGL','YKBNK','TOASO','TUPRS','KRDMD','TTRAK','ASELS','IPEKE','KOZAA','ASYAB','ENKAI','KOZAL','DOHOL','IHLAS','KCHOL','EKGYO','TCELL','MGROS','SISE','ISCTR','VAKBN','AKBNK','PETKM','THYAO','TTKOM','HALKB')
```


After that, we can apply correlatio between all the prices and volumes.

```{r}
df <- bist30
corGaran <- cor(df$GARAN_Price,df$GARAN_Volume)
corSahol <- cor(df$SAHOL_Price,df$SAHOL_Volume)
corBimas <- cor(df$BIMAS_Price,df$BIMAS_Volume)
corArclk <- cor(df$ARCLK_Price,df$ARCLK_Volume)
corEregl <- cor(df$EREGL_Price,df$EREGL_Volume)
corYkbnk <- cor(df$`YKBNK _Price`,df$`YKBNK _Volume`)
corToaso <- cor(df$TOASO_Price,df$TOASO_Volume)
corTuprs <- cor(df$TUPRS_Price,df$TUPRS_Volume)
corKrdmd <- cor(df$KRDMD_Price,df$KRDMD_Volume)
corTtrak <- cor(df$TTRAK_Price,df$TTKOM_Volume)
corAsels <- cor(df$ASELS_Price,df$ASELS_Volume)
corIpeke <- cor(df$IPEKE_Price,df$IPEKE_Volume)
corKozaa <- cor(df$KOZAA_Price,df$KOZAA_Volume)
corAsyab <- cor(df$ASYAB_Price,df$ASYAB_Volume)
corEnkai <- cor(df$ENKAI_Price,df$ENKAI_Volume)
corKozal <- cor(df$KOZAL_Price,df$KOZAL_Volume)
corDohol <- cor(df$DOHOL_Price,df$DOHOL_Volume)
corIhlas <- cor(df$IHLAS_Price,df$IHLAS_Volume)
corKchol <- cor(df$KCHOL_Price,df$KCHOL_Volume)
corEgkyo <- cor(df$EKGYO_Price,df$EKGYO_Volume)
corTcell <- cor(df$TCELL_Price,df$TCELL_Volume)
corMgros <- cor(df$MGROS_Price,df$MGROS_Volume)
corSise <- cor(df$SISE_Price,df$SISE_Volume)
corIsctr <- cor(df$ISCTR_Price,df$ISCTR_Volume)
corVakbn <- cor(df$VAKBN_Price,df$VAKBN_Volume)
corAkbnk <- cor(df$AKBNK_Price,df$AKBNK_Volume)
corPetkm <- cor(df$PETKM_Price,df$PETKM_Volume)
corThyao <- cor(df$THYAO_Price,df$THYAO_Volume)
corTtkom <- cor(df$TTKOM_Price,df$TTKOM_Volume)
corHalkb <- cor(df$HALKB_Price,df$HALKB_Volume)

corVec <- c(corGaran,corSahol,corBimas,corArclk,corEregl,corYkbnk,corToaso,corTuprs,corKrdmd,corTtrak,corAsels,corIpeke,corKozaa,corAsyab,corEnkai,corKozal,corDohol,corIhlas,corKchol,corEgkyo,corTcell,corMgros,corSise,corIsctr,corVakbn,corAkbnk,corPetkm,corThyao,corTtkom,corHalkb )
```


```{r}
corrTable <- melt(data.frame(companyNames ,corVec))
corrTable$variable <- NULL
corrTable
```



**CorVec** variable keeps the correlation values between prices and volumes . There are negative and positive values. The absolute value of correlation means the relationship of these two variables are more predictable and more meaningfull for future actions. Thus, investigating these correlation values could help for regression values to seek which stocks are the best for prediction.

```{r}
theme_set(theme_bw())

corrTable %>% arrange(desc(value)) %>%
ggplot( aes(x=companyNames, y=value)) + 
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Ordered Bar Chart", 
       subtitle="Correlation Values", 
       caption="Correlation graph") + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6))
```

Arranging to absolute values

```{r}
corrTable %>% arrange(desc(abs(value)))
```



## 3) General Template for Highly Correlated Values


```{r}
ggpairs(df, 
        columns = c("KRDMD_Price","KRDMD_Volume","ASELS_Price","ASELS_Volume","ASYAB_Price","ASYAB_Volume","TTKOM_Price","TTKOM_Volume","HALKB_Price","HALKB_Volume"), 
        upper = list(continuous = wrap("cor", 
                                       size = 10)), 
        lower = list(continuous = "smooth"))
```

## 4) Highly Correlated Price Values


First, we need to see the relation of the price and volumes for each column.

```{r}
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
```

```{r}
corrData<-rcorr(as.matrix(df[,2:60]))
generalCorData <- flattenCorrMatrix(corrData$r, corrData$P)
generalCorData

generalCorData$Names <- paste(generalCorData$row,generalCorData$column,sep= "&")

```

Comparison of the results between each column correlation values to related price-volume correlation values


```{r}
theme_set(theme_bw())

generalCorData %>% arrange(desc(abs(cor))) %>%
  filter(cor > 0.95) %>%
ggplot( aes(x=Names, y=cor)) + 
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Ordered Bar Chart", 
       subtitle="Correlation Values", 
       caption="Correlation graph") + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6))
```

```{r}
generalCorData %>% arrange(desc(abs(cor))) %>%
  filter(cor > 0.95) 
```

Let's draw these relations with **ggplot** library



Result: So there is a highly correlation between some prices. Therefore, if there is relation, we can examine the predictions on these values.

```{r}
ggpairs(df, 
        columns = c("ASELS_Price","PETKM_Price","EREGL_Price","SISE_Price","GARAN_Price","AKBNK_Price","TOASO_Price","KCHOL_Price","TUPRS_Price"), 
        upper = list(continuous = wrap("cor", 
                                       size = 10)), 
        lower = list(continuous = "smooth"))
```

# 5) Linear Models {.tabset .tabset-fade .tabset-pills}

## 1) Linear Regression Model for Mostly Correlated Volume-Price Values


We can analyze the first five company which have the highest correlation volume-price relation values of all.Thus, if we look at the correlation table of volume-price relation, we can see that:

**KRDMD** is the first one

```{r}
ggplot(df, aes(df$KRDMD_Price, df$KRDMD_Volume)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**ASELS** is the second one

```{r}
ggplot(df, aes(df$ASELS_Price, df$ASELS_Volume)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**ASYAB** is the third one

```{r}
ggplot(df, aes(df$ASYAB_Price, df$ASYAB_Volume)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**TTKOM** is the forth one

```{r}
ggplot(df, aes(df$TTKOM_Price, df$TTKOM_Volume)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**HALKB** is the fifth one

```{r}
ggplot(df, aes(df$HALKB_Price, df$HALKB_Volume)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

## 2) Linear Regression Charts for These Highly Correlated Prices

Let's plot them together with **grid** function

**TOASO & KCHOL** is the first one

```{r}
g1 <- ggplot(df, aes(df$TOASO_Price, df$KCHOL_Price)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**TUPRS & ASELS** is the second one

```{r}
g2 <- ggplot(df, aes(df$TUPRS_Price, df$ASELS_Price)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**ASELS & PETKM** is the third one

```{r}
g3 <- ggplot(df, aes(df$ASELS_Price, df$PETKM_Price)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**EREGL & SISE** is the forth one

```{r}
g4 <- ggplot(df, aes(df$EREGL_Price, df$SISE_Price)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

**GARAN & AKBNK** is the fifth one

```{r}
g5 <- ggplot(df, aes(df$GARAN_Price, df$AKBNK_Price)) + 
  geom_count(color="darkred") + 
  geom_smooth(method="lm", se=F,color="blue")
```

Together their table is like this

```{r}
grid.arrange(g1, 
             g2,
             g3,
             g4,
             g5,
             nrow=5)
```

## 3) Linear Models for These Highly Correlated Prices


With **lm** function we can see the relation between data as linear model

```{r}
linearMod1_1 <- lm(df$TOASO_Price ~ df$KCHOL_Price, data=df)
linearMod1_2 <- lm(df$TUPRS_Price ~ df$ASELS_Price, data=df)
linearMod1_3 <- lm(df$ASELS_Price ~ df$PETKM_Price, data=df)
linearMod1_4 <- lm(df$EREGL_Price ~ df$SISE_Price, data=df)
linearMod1_5 <- lm(df$GARAN_Price ~ df$AKBNK_Price, data=df)
summary(linearMod1_1)
summary(linearMod1_2)
summary(linearMod1_3)
summary(linearMod1_4)
summary(linearMod1_5)
```

Formula Model 1: $-7.17270  + 2.13500 * X$

Adjusted R-squared:  $0.9331$


Formula Model 2: $36.75406  + 2.90503 * X$

Adjusted R-squared:  $0.9238$


Formula Model 3: $-5.34984  + 5.29687 * X$

Adjusted R-squared:  $0.9141$


Formula Model 4: $-2.34248  + 2.44400 * X$

Adjusted R-squared:  $0.9108$


Formula Model 5: $-0.41338  + 1.08461 * X$

Adjusted R-squared:  $0.9101$


The Adjusted R-squared values are really high. That's why, we can say that, the prediction made between prices are highly elective and measurable.


## 4) Linear Models for These Specific Stocks


And **linear models** for these stocks are

```{r}
linearMod2_1<- lm(df$KRDMD_Price ~ df$KRDMD_Volume, data=df)
linearMod2_2 <- lm(df$ASELS_Price ~ df$ASELS_Volume, data=df)
linearMod2_3 <- lm(df$ASYAB_Price ~ df$ASYAB_Volume, data=df)
linearMod2_4 <- lm(df$TTKOM_Price ~ df$TTKOM_Volume, data=df)
linearMod2_5 <- lm(df$HALKB_Price ~ df$HALKB_Volume, data=df)
summary(linearMod2_1)
summary(linearMod2_2)
summary(linearMod2_3)
summary(linearMod2_4)
summary(linearMod2_5)
```

Formula Model 1: $8.495e-01 + 1.624e-08 * X$

Adjusted R-squared: $0.4025$


Formula Model 2: $7.391e+00 + 5.014e-07 * X$

Adjusted R-squared: $0.2563$


Formula Model 3: $1.183e+00 + 2.132e-08 * X$

Adjusted R-squared: $0.1787$


Formula Model 4: $6.662e+00 + -2.370e-08 * X$

Adjusted R-squared: $0.1714$


Formula Model 5: $1.375e+01 + -6.544e-08 * X$

Adjusted R-squared: $0.1586$


The adjusted R-squared values are really high for volume-price relationship of same companies' stock. That's why, we can say that, the volume and price predictions are not reliable and not greatly measurable.


# 6) K-Means Analysis

We have divided the dataset into two groups as financial sector companies and real sector companies. Now we will check whether this classification is true or not by using k-means.

```{r echo=TRUE}
#we calculate the annual average of stocks.
annual_average<- aggregate(bist30[,62:91], list(format(bist30$Dates, "%Y")), mean)
View(annual_average)

#get transpose of annual_average dataset. 
transpose <- as.matrix(annual_average[,-1])
rownames(transpose) <- annual_average[,1]
annual_average <- t(transpose)
View(annual_average)

#lets define wcss(Within cluster sum of squares) vector. 
wcss <- vector()

#lets find the distance to the center for each predefined center numbers.
for (i in 1:7) wcss[i] <- sum(kmeans(annual_average, i)$withinss)
View(wcss)

#lets determine the breakdown point of the wcss graph. 
plot(1:7, wcss, type="l")

#3 centers are the optimum number for centers.
kmeans(annual_average, 3)


```



## 1) Cluster Table

Structuring the table for **kmeans**.

```{r}
c1 <- companyNames
c2 <- c(3,3,2,2,2,3,2,2,2,2,1,3,3,3,3,3,3,3,2,3,3,3,2,3,3,3,2,2,3,3)
clusterFrame <- melt(data.frame(c1,c2))
clusterFrame$variable <- NULL
names(clusterFrame) <- c("Companies","Groups")

```

```{r echo = FALSE, results = 'asis'}
kable(clusterFrame,caption = "Kmeans Cluster Table")

```


```{r}
ggplot(clusterFrame, aes(x =Groups , y = seq(1,30,1), colour = Groups,fill = Groups)) + geom_text(label = clusterFrame$Companies) + 
  xlab(label = "Numbers of Groups") +
  ylab(label = "Seperation according to Sequence") 
```
          
      

## 2) Sum of Squares

$$\frac{betweenSS}{totalSS} = 87.5 $$



Consequently, we can assume **Aselsan** as an outlier, so the result of k-means match up with our first assumption (there are two groups in bist30 stock such as real sector and financial sector) with regards to group classification.

# 7) References

[1] - Correlation Graphs [link](https://www.datacamp.com/community/blog/r-correlation-tutorial)

[2] - Correlation Graphs 
[link](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html)

[3] - General Graphs [link](http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html)

[4] - Math formulas for R Markdown [link](https://www.calvin.edu/~rpruim/courses/s341/S17/from-class/MathinRmd.html)

[5] - R Markdown Style 
[link](https://bookdown.org/yihui/rmarkdown/html-document.html)




